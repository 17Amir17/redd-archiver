# ============================================================================
# Redd-Archiver Environment Configuration Template
# ============================================================================
# Copy this file to .env and customize for your deployment:
#   cp .env.example .env
#
# ⚠️  SECURITY WARNING ⚠️
# - NEVER commit .env files with real credentials to version control!
# - CHANGE ALL DEFAULT PASSWORDS before deploying
# - Keep .env file permissions restricted: chmod 600 .env
# - The .env file is in .gitignore by default
# ============================================================================
#
# ⚠️  MINIMUM REQUIRED CHANGES FOR DEPLOYMENT ⚠️
#
# Local/Tor Testing:
#   - POSTGRES_PASSWORD (MUST CHANGE)
#
# Production HTTPS:
#   - POSTGRES_PASSWORD (MUST CHANGE)
#   - DOMAIN (uncomment and set)
#   - EMAIL (uncomment and set)
#
# All other values can use defaults for initial deployment.
# See QUICKSTART.md for step-by-step deployment guide.
#
# ============================================================================

# ============================================================================
# PostgreSQL Database Configuration (REQUIRED)
# ============================================================================

# Database credentials
# ⚠️  CHANGE THESE PASSWORDS IN PRODUCTION!
POSTGRES_DB=reddarchiver
POSTGRES_USER=reddarchiver
POSTGRES_PASSWORD=your_secure_password_here

# PostgreSQL port (default: 5432)
POSTGRES_PORT=5432

# ============================================================================
# Database Connection Strings
# ============================================================================

# Primary: Unix socket connection (15-30% faster than TCP)
# Used when both containers run on same host (Docker Compose)
DATABASE_URL=postgresql://reddarchiver:your_secure_password_here@/reddarchiver?host=/var/run/postgresql

# Fallback: TCP connection
# Used for external access, monitoring tools, or when Unix socket unavailable
DATABASE_URL_TCP=postgresql://reddarchiver:your_secure_password_here@postgres:5432/reddarchiver

# ============================================================================
# PostgreSQL Performance Tuning
# ============================================================================

# Shared memory for PostgreSQL (for parallel queries)
# Recommended: 256mb for development, 512mb-1gb for production
POSTGRES_SHM_SIZE=256mb

# Additional PostgreSQL settings (override postgres.conf)
# POSTGRES_SHARED_BUFFERS=4GB
# POSTGRES_MAX_CONNECTIONS=100
# POSTGRES_WORK_MEM=256MB

# ============================================================================
# Application Settings
# ============================================================================

# Python version (used in Dockerfile build)
PYTHON_VERSION=3.12

# Logging level (DEBUG, INFO, WARNING, ERROR)
LOG_LEVEL=INFO

# Memory limit for incremental processor (in GB)
# Set lower for systems with limited RAM
MEMORY_LIMIT=15.0

# ============================================================================
# Instance Metadata (for /api/v1/stats endpoint)
# ============================================================================

# Instance name displayed in search interface and API
# CLI arg: --site-name (already exists)
REDDARCHIVER_SITE_NAME=Redd Archive

# Optional: Instance description for registry leaderboard
# CLI arg: --site-description (new)
# REDDARCHIVER_SITE_DESCRIPTION=Community-maintained archive of Reddit discussions

# Optional: Contact method (email, URL, Matrix, GitHub, etc.)
# CLI arg: --contact (new)
# Examples: admin@example.com, https://matrix.to/#/@user:matrix.org, @github_user
# REDDARCHIVER_CONTACT=admin@example.com

# Optional: Team identifier for registry grouping
# CLI arg: --team-id (new)
# REDDARCHIVER_TEAM_ID=privacy-advocates

# Optional: Donation method (URL, crypto address, payment link, etc.)
# CLI arg: --donation-address (new)
# Examples: https://donate.com, bc1q..., 0x..., https://patreon.com/...
# REDDARCHIVER_DONATION_ADDRESS=https://donate.example.com

# Optional: Base URL for clearnet access (used in registry and canonical links)
# CLI arg: --base-url (already exists)
# REDDARCHIVER_BASE_URL=https://archive.example.com

# ============================================================================
# Redd-Archiver Performance Tuning (Optional - Advanced Users)
# ============================================================================

# PostgreSQL connection pool size
# Auto-detected based on CPU cores if not set
# ARCHIVE_MAX_DB_CONNECTIONS=8

# Maximum parallel worker processes
# Auto-detected based on CPU cores and memory if not set
# ARCHIVE_MAX_PARALLEL_WORKERS=4

# Number of users per batch for streaming user page generation
# Larger = faster but more memory usage
# ARCHIVE_USER_BATCH_SIZE=2000

# Maximum queued batches (backpressure control)
# Prevents memory overflow with slow consumers
# ARCHIVE_QUEUE_MAX_BATCHES=10

# Checkpoint interval (batches between progress saves)
# Lower = more frequent saves, slower performance
# ARCHIVE_CHECKPOINT_INTERVAL=10

# Number of parallel workers for user page generation
# Auto-detected if not set
# ARCHIVE_USER_PAGE_WORKERS=4

# Skip index creation (internal use - set by code automatically)
# ARCHIVE_SKIP_INDEX_CREATION=false

# Resume mode flags (internal use - set by code automatically)
# ARCHIVE_RESUME_MODE=false
# ARCHIVE_RESUME_ACTIVE=false

# ============================================================================
# Flask Search Server Configuration
# ============================================================================

# Flask environment (development, production)
FLASK_ENV=production
FLASK_DEBUG=False

# Flask secret key for session management
# ⚠️  REQUIRED FOR PRODUCTION!
# Generate with: python3 -c "import secrets; print(secrets.token_hex(32))"
FLASK_SECRET_KEY=generate_random_secret_key_here

# Search server port (default: 5000)
SEARCH_PORT=5000

# ============================================================================
# Nginx Configuration
# ============================================================================

# HTTP port (default: 80)
# Use 8080 for development to avoid requiring root privileges
NGINX_PORT=80

# Worker processes (auto = match CPU cores)
NGINX_WORKER_PROCESSES=auto

# Maximum client request body size
NGINX_CLIENT_MAX_BODY_SIZE=1m

# Logging level (debug, info, notice, warn, error, crit)
NGINX_LOG_LEVEL=warn

# ============================================================================
# Volume Paths
# ============================================================================

# Input data directory (contains .zst files)
DATA_PATH=./data

# Output directory (generated HTML archive)
OUTPUT_PATH=./output

# Log directory (processing logs)
LOG_PATH=./logs

# ============================================================================
# Resource Limits (Optional - Uncomment for Production)
# ============================================================================

# PostgreSQL container limits
# POSTGRES_CONTAINER_MEMORY=4g
# POSTGRES_CONTAINER_CPUS=4

# Builder container limits
# BUILDER_CONTAINER_MEMORY=2g
# BUILDER_CONTAINER_CPUS=2

# ============================================================================
# Development Options
# ============================================================================

# Enable PostgreSQL query logging for debugging
# POSTGRES_LOG_STATEMENT=all
# POSTGRES_LOG_MIN_DURATION_STATEMENT=0

# ============================================================================
# Production Options
# ============================================================================

# For production deployments, consider:
# 1. Strong POSTGRES_PASSWORD (use secrets management)
# 2. Enable resource limits (memory, CPU)
# 3. Configure backup volumes
# 4. Use TCP connection for remote PostgreSQL
# 5. Enable monitoring (Prometheus, Grafana)
# 6. Configure HTTPS with Let's Encrypt (see section below)

# ============================================================================
# HTTPS Configuration (Optional - Production Only)
# ============================================================================

# Your domain name (REQUIRED for HTTPS)
# Must have DNS A record pointing to this server's IP address
# Example: DOMAIN=archive.example.com
#DOMAIN=example.com

# Email for Let's Encrypt notifications (certificate expiration warnings)
# REQUIRED for production - Let's Encrypt uses this for important updates
# Example: EMAIL=admin@example.com
#EMAIL=admin@example.com

# Let's Encrypt staging server (for testing)
# Set to true initially to avoid rate limits during setup
# Switch to false once configuration is verified
# Staging certificates are not trusted by browsers but allow unlimited testing
#CERTBOT_TEST_CERT=true

# Port Configuration
# Development: HTTP only on port 80 (or 8080 to avoid requiring root)
# Production: HTTP (80) redirects to HTTPS (443)
#HTTP_PORT=80
#HTTPS_PORT=443

# Advanced Certbot Options (usually defaults are fine)
#CERTBOT_RSA_KEY_SIZE=4096                # RSA key size (2048 or 4096)
#CERTBOT_RENEWAL_INTERVAL=12h             # How often to check for renewal

# ============================================================================
# HTTPS Usage Instructions
# ============================================================================
#
# Local Development (no HTTPS):
#   1. No HTTPS configuration needed
#   2. Run: docker compose up -d
#   3. Access: http://localhost
#   4. Certbot container never starts (profile not activated)
#
# Production Hosting (with HTTPS):
#   1. Set DOMAIN and EMAIL above (uncomment and configure)
#   2. Configure DNS A record pointing to server IP
#   3. Run: ./docker/scripts/init-letsencrypt.sh
#   4. Script automates certificate acquisition and HTTPS setup
#   5. Access: https://your-domain.com
#   6. Certificates renew automatically every 90 days
#
# Manual Setup (alternative to init script):
#   1. Configure .env with DOMAIN and EMAIL
#   2. Start services: docker compose up -d
#   3. Request certificate: docker compose run --rm certbot certonly --webroot --webroot-path=/var/www/certbot --email your@email.com --agree-tos -d your-domain.com
#   4. Switch to HTTPS: docker compose --profile production up -d
#
# See docker/README.md for detailed HTTPS deployment guide

# ============================================================================
# Tor Hidden Service Configuration (Optional)
# ============================================================================

# Directory for hidden service keys and hostname
# IMPORTANT: Backup this directory - contains your .onion private keys
# If lost, your .onion address changes permanently (breaks existing links)
#TOR_HIDDEN_SERVICE_DIR=./tor-hidden-service

# Tor logging level (debug, info, notice, warn, err)
# Use 'notice' for normal operation, 'info' for troubleshooting
#TOR_LOG_LEVEL=notice

# SOCKS proxy port (for internal routing, not exposed to host)
# Default: 9050 (standard Tor SOCKS port)
#TOR_SOCKS_PORT=9050

# ============================================================================
# Tor Usage Instructions
# ============================================================================
#
# Dual-Mode Deployment (HTTPS + Tor):
#   1. Set DOMAIN and EMAIL for HTTPS (see HTTPS section above)
#   2. Run HTTPS setup: ./docker/scripts/init-letsencrypt.sh
#   3. Start with both profiles: docker compose --profile production --profile tor up -d
#   4. Get .onion address: docker compose logs tor | grep "Your .onion address"
#   5. Access via:
#      - Clearnet: https://your-domain.com
#      - Tor: http://xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx.onion
#
# Tor-Only Deployment (Homelab/Privacy):
#   Perfect for homelab users - no port forwarding or DNS needed!
#   1. Start with tor profile: docker compose -f docker-compose.yml -f docker-compose.tor-only.yml --profile tor up -d
#   2. Get .onion address: docker compose logs tor | grep "Your .onion address"
#   3. Share .onion address with users (via email, chat, etc.)
#   4. Access ONLY via Tor Browser: http://[your-address].onion
#   5. No port forwarding, no domain name, no internet exposure!
#
# Security Notes:
#   - Backup ./tor-hidden-service/ directory regularly
#   - .onion address is cryptographically derived from private key
#   - Changing/losing private key = new .onion address (all links break)
#   - Never share hs_ed25519_secret_key file
#   - hostname file is public (safe to share your .onion address)
#
# See docker/README.md for detailed Tor deployment guide

# ============================================================================
# Notes
# ============================================================================

# Unix Socket Performance:
# - 15-30% faster than TCP for bulk operations
# - Best for single-host Docker Compose deployments
# - Connection establishment is 2-5x faster
#
# TCP Socket Usage:
# - Required for remote PostgreSQL servers
# - Needed for external tools (pgAdmin, monitoring)
# - Use when containers are on different hosts
#
# Memory Recommendations:
# - Development: 8GB system RAM minimum
# - Small archives (<100k posts): 4GB PostgreSQL + 2GB builder
# - Large archives (>500k posts): 8GB PostgreSQL + 4GB builder
